<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pharmacy SOP Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <!-- Materialize CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Alpine.js -->
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="grey lighten-4" x-data="sopApp()" x-init="init()">
    <nav class="blue darken-2 no-print">
      <div class="nav-wrapper container">
        <span class="brand-logo">Pharmacy SOP Generator</span>
        <ul class="right">
          <li><a href="#" @click.prevent="resetForm()" title="Reset Form"><i class="material-icons">refresh</i></a></li>
          <li><a href="#" @click.prevent="exportData()" title="Export Data"><i class="material-icons">save_alt</i></a></li>
        </ul>
      </div>
    </nav>

    <!-- Loading Indicator -->
    <div x-show="isLoading" class="progress blue lighten-4 no-print" style="margin: 0;">
      <div class="indeterminate blue"></div>
    </div>

    <div class="container section no-print">
      <!-- SOP MODE -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">SOP Mode</span>
          <label>
            <input
              type="radio"
              name="mode"
              value="predefined"
              :checked="sopMode === 'predefined'"
              @change="switchMode('predefined')"
            />
            <span>Predefined SOP</span>
          </label>
          &nbsp;&nbsp;
          <label>
            <input
              type="radio"
              name="mode"
              value="custom"
              :checked="sopMode === 'custom'"
              @change="switchMode('custom')"
            />
            <span>Custom SOP</span>
          </label>
        </div>
      </div>

      <!-- SOP FORMAT -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">SOP Format</span>
          <button class="btn blue" @click="toggleFormat()">
            Switch to
            <span
              x-text="format === 'inspection' ? 'Beginner' : 'Inspection'"
            ></span>
          </button>
          <span class="grey-text text-darken-2" style="margin-left: 20px;">
            Current: <strong x-text="format === 'inspection' ? 'Inspection' : 'Beginner'"></strong>
          </span>
        </div>
      </div>

      <div class="row">
        <!-- LEFT COLUMN -->
        <div class="col s12 m6">
          <!-- INSTITUTE & METADATA -->
          <div class="card">
            <div class="card-content">
              <span class="card-title">Institute & Metadata</span>
              <div class="input-field">
                <input 
                  id="institute-name"
                  type="text" 
                  placeholder="Institute / College Name" 
                  x-model="institute.name"
                  maxlength="200" />
                <label for="institute-name" class="active">Institute Name <span class="red-text">*</span></label>
              </div>
              
              <div class="input-field">
                <input 
                  id="department"
                  type="text"
                  placeholder="Department" 
                  x-model="institute.dept"
                  maxlength="100" />
                <label for="department" class="active">Department <span class="red-text">*</span></label>
              </div>
              
              <div class="input-field">
                <input 
                  id="sop-number"
                  type="text"
                  placeholder="SOP Number" 
                  x-model="metadata.sopNumber"
                  maxlength="50" />
                <label for="sop-number" class="active">SOP Number <span class="red-text">*</span></label>
                <span class="helper-text">Format: DEPT-XXX-YYYY</span>
              </div>
              
              <div class="input-field">
                <input 
                  id="effective-date"
                  type="date" 
                  x-model="metadata.effectiveDate" />
                <label for="effective-date" class="active">Effective Date <span class="red-text">*</span></label>
              </div>
              
              <div class="input-field">
                <input 
                  id="review-date"
                  type="date" 
                  x-model="metadata.nextReviewDate" />
                <label for="review-date" class="active">To Be Reviewed On</label>
              </div>
            </div>
          </div>

          <!-- SOP SELECTION -->
          <div x-show="sopMode === 'predefined'">
            <div class="card">
              <div class="card-content">
                <span class="card-title">SOP Selection</span>

                <div class="input-field">
                  <select
                    class="browser-default"
                    @change="departmentChanged($event)"
                  >
                    <option value="" disabled selected>
                      Select Department
                    </option>
                    <template x-for="d in departments" :key="d.key">
                      <option :value="d.key" x-text="d.name"></option>
                    </template>
                  </select>
                  <label class="active">Department</label>
                </div>

                <div class="input-field">
                  <select class="browser-default" @change="sopChanged($event)" :disabled="sopList.length === 0">
                    <option value="" disabled selected>Select SOP</option>
                    <template x-for="s in sopList" :key="s.key">
                      <option :value="s.key" x-text="s.name"></option>
                    </template>
                  </select>
                  <label class="active">SOP</label>
                  <span class="helper-text" x-show="sopList.length === 0">No SOPs available for this department</span>
                </div>
              </div>
            </div>
          </div>

          <!-- SOP CONTENT -->
          <div class="card">
            <div class="card-content">
              <span class="card-title">SOP Content</span>
              
              <div class="input-field">
                <input 
                  id="sop-title"
                  type="text"
                  placeholder="SOP Title" 
                  x-model="title"
                  maxlength="200" />
                <label for="sop-title" class="active">SOP Title <span class="red-text">*</span></label>
              </div>
              
              <div class="input-field">
                <textarea
                  id="purpose"
                  class="materialize-textarea"
                  placeholder="Purpose"
                  x-model="sections.purpose"
                  maxlength="1000"
                ></textarea>
                <label for="purpose" class="active">Purpose <span class="red-text">*</span></label>
                <span class="helper-text">Minimum 20 characters</span>
              </div>
              
              <div class="input-field">
                <textarea
                  id="scope"
                  class="materialize-textarea"
                  placeholder="Scope"
                  x-model="sections.scope"
                  maxlength="1000"
                ></textarea>
                <label for="scope" class="active">Scope <span class="red-text">*</span></label>
                <span class="helper-text">Minimum 20 characters</span>
              </div>
              
              <div class="input-field">
                <textarea
                  id="procedure"
                  class="materialize-textarea"
                  placeholder="Procedure (one step per line)"
                  x-model="sections.procedure"
                  maxlength="5000"
                ></textarea>
                <label for="procedure" class="active">Procedure <span class="red-text">*</span></label>
                <span class="helper-text">Enter each step on a new line</span>
              </div>
              
              <div class="input-field">
                <textarea
                  id="precautions"
                  class="materialize-textarea"
                  placeholder="Precautions"
                  x-model="sections.precautions"
                  maxlength="2000"
                ></textarea>
                <label for="precautions" class="active">Precautions</label>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col s12 m6">
          <!-- AUTHORITIES -->
          <div class="card">
            <div class="card-content">
              <span class="card-title">Authorities</span>

              <div class="input-field">
                <input
                  id="prepared-name"
                  type="text"
                  placeholder="Prepared By – Name"
                  x-model="authority.prepared"
                  maxlength="100"
                />
                <label for="prepared-name" class="active">Prepared By - Name</label>
              </div>
              
              <div class="input-field">
                <input
                  id="prepared-desig"
                  type="text"
                  placeholder="Prepared By – Designation"
                  x-model="authority.preparedDesig"
                  maxlength="100"
                />
                <label for="prepared-desig" class="active">Prepared By - Designation</label>
              </div>

              <div class="input-field">
                <input
                  id="reviewed-name"
                  type="text"
                  placeholder="Reviewed By – Name"
                  x-model="authority.reviewed"
                  maxlength="100"
                />
                <label for="reviewed-name" class="active">Reviewed By - Name</label>
              </div>
              
              <div class="input-field">
                <input
                  id="reviewed-desig"
                  type="text"
                  placeholder="Reviewed By – Designation"
                  x-model="authority.reviewedDesig"
                  maxlength="100"
                />
                <label for="reviewed-desig" class="active">Reviewed By - Designation</label>
              </div>

              <div class="input-field">
                <input
                  id="approved-name"
                  type="text"
                  placeholder="Approved By – Name"
                  x-model="authority.approved"
                  maxlength="100"
                />
                <label for="approved-name" class="active">Approved By - Name</label>
              </div>
              
              <div class="input-field">
                <input
                  id="approved-desig"
                  type="text"
                  placeholder="Approved By – Designation"
                  x-model="authority.approvedDesig"
                  maxlength="100"
                />
                <label for="approved-desig" class="active">Approved By - Designation</label>
              </div>

              <div class="input-field">
                <input 
                  id="date-prepared"
                  type="date" 
                  x-model="dates.prepared" />
                <label for="date-prepared" class="active">Date Prepared</label>
              </div>
              
              <div class="input-field">
                <input 
                  id="date-reviewed"
                  type="date" 
                  x-model="dates.reviewed" />
                <label for="date-reviewed" class="active">Date Reviewed</label>
              </div>
              
              <div class="input-field">
                <input 
                  id="date-approved"
                  type="date" 
                  x-model="dates.approved" />
                <label for="date-approved" class="active">Date Approved</label>
              </div>
            </div>
          </div>

          <div class="card center-align">
            <div class="card-content">
              <button
                class="btn-large green waves-effect waves-light"
                @click="printSOP()"
                :disabled="!title"
              >
                <i class="material-icons left">print</i>
                Print SOP
              </button>
              <p class="grey-text" x-show="!title" style="margin-top: 10px;">
                Please fill in the SOP Title to enable printing
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRINT ZONE -->
    <div id="print-zone">
      <div id="preview">
        <!-- Institute Name (Normal Description) -->
        <p style="text-align: center; font-weight: bold; font-size: 14pt; margin-top: 0;">
          <span x-text="institute.name"></span>
        </p>

        <!-- SOP Heading (No Format Suffix) -->
        <h3>STANDARD OPERATING PROCEDURE</h3>

        <!-- Updated Header Table -->
        <table>
          <!-- Row 1: SOP Number & Effective Date -->
          <tr>
            <td width="20%"><b>SOP No.</b></td>
            <td width="30%" x-text="metadata.sopNumber"></td>
            <td width="20%"><b>Effective Date</b></td>
            <td width="30%" x-text="metadata.effectiveDate"></td>
          </tr>

          <!-- Row 2: Department & To Be Reviewed On -->
          <tr>
            <td><b>Department</b></td>
            <td x-text="institute.dept"></td>
            <td><b>To Be Reviewed On</b></td>
            <td x-text="metadata.nextReviewDate"></td>
          </tr>

          <!-- Row 3: SOP Title (Spans full width) -->
          <tr>
            <td colspan="4"><b>SOP Title:</b> <span x-text="title"></span></td>
          </tr>
        </table>

        <h4>1.0 Purpose</h4>
        <p x-text="sections.purpose"></p>

        <h4>2.0 Scope</h4>
        <p x-text="sections.scope"></p>

        <h4>3.0 Procedure</h4>
        <ol>
          <template x-for="step in procedureList" :key="step">
            <li x-text="step"></li>
          </template>
        </ol>

        <h4>4.0 Precautions</h4>
        <ul>
          <template x-for="p in precautionsList" :key="p">
            <li x-text="p"></li>
          </template>
        </ul>

        <table style="margin-top: 20mm">
          <tr>
            <td>
              <b>Prepared By</b><br />
              <span x-text="authority.prepared"></span><br />
              <span
                class="signature-designation"
                x-text="authority.preparedDesig"
              ></span
              ><br />
              Date: <span class="signature-date" x-text="dates.prepared"></span>
            </td>

            <td>
              <b>Reviewed By</b><br />
              <span x-text="authority.reviewed"></span><br />
              <span
                class="signature-designation"
                x-text="authority.reviewedDesig"
              ></span
              ><br />
              Date: <span class="signature-date" x-text="dates.reviewed"></span>
            </td>

            <td>
              <b>Approved By</b><br />
              <span x-text="authority.approved"></span><br />
              <span
                class="signature-designation"
                x-text="authority.approvedDesig"
              ></span
              ><br />
              Date: <span class="signature-date" x-text="dates.approved"></span>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="js/alpineApp.js"></script>
  </body>
</html>