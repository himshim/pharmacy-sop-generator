<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Generate professional Standard Operating Procedures (SOPs) for pharmacy and pharmaceutical laboratories with predefined templates or custom content."
    />
    <meta
      name="keywords"
      content="SOP, Standard Operating Procedure, Pharmacy, Pharmaceutical, Laboratory, Template Generator"
    />
    <meta name="author" content="Pharmacy SOP Generator" />

    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#1976d2" />

    <title>Pharmacy SOP Generator - Professional SOP Templates</title>

    <!-- Materialize CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!-- Material Icons -->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css?v=2.1.0" />

    <!-- Print-specific styles -->
    <style>
      @media print {
        /* Hide everything except preview during print */
        body > *:not(#preview-container) {
          display: none !important;
        }

        #preview-container {
          position: static !important;
          width: 210mm !important;
          height: auto !important;
          padding: 0 !important;
          margin: 0 !important;
          box-shadow: none !important;
          border: none !important;
          page-break-after: always;
        }

        #preview {
          width: 210mm !important;
          min-height: 297mm !important;
          padding: 20mm 25mm !important;
          margin: 0 !important;
          box-shadow: none !important;
          border: none !important;
          background: white !important;
        }

        /* Ensure proper page breaks */
        .page-break {
          page-break-before: always;
        }

        /* Force Times New Roman for print */
        * {
          font-family: "Times New Roman", serif !important;
        }
      }
    </style>
  </head>
  <body>
    <!-- Main Application Container -->
    <div x-data="sopApp()" x-init="init()" class="app-container">
      <!-- Header -->
      <header class="app-header blue darken-2">
        <div class="container">
          <div class="header-content">
            <h1 class="app-title">
              <i class="material-icons">description</i>
              Pharmacy SOP Generator
            </h1>
            <p class="app-subtitle">
              Professional Standard Operating Procedures
            </p>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="container main-content">
        <div class="row">
          <!-- Left Column: Editor -->
          <div class="col s12 l7">
            <div class="editor-section card">
              <div class="card-content">
                <!-- Mode Selection -->
                <div class="section">
                  <h5 class="section-title">
                    <i class="material-icons">settings</i>
                    SOP Mode
                  </h5>
                  <div class="mode-toggle">
                    <label for="sopModePredefined">
                      <input
                        type="radio"
                        id="sopModePredefined"
                        name="sopMode"
                        value="predefined"
                        x-model="sopMode"
                        @change="switchMode('predefined')"
                        class="with-gap"
                      />
                      <span>Predefined Templates</span>
                    </label>
                    <label for="sopModeCustom">
                      <input
                        type="radio"
                        id="sopModeCustom"
                        name="sopMode"
                        value="custom"
                        x-model="sopMode"
                        @change="switchMode('custom')"
                        class="with-gap"
                      />
                      <span>Custom SOP</span>
                    </label>
                  </div>
                </div>

                <!-- Template Selection (Predefined Mode) -->
                <div x-show="sopMode === 'predefined'" class="section">
                  <h5 class="section-title">
                    <i class="material-icons">folder</i>
                    Select Template
                  </h5>

                  <!-- Department Selection -->
                  <div class="input-field">
                    <label for="departmentSelect" class="active"
                      >Department</label
                    >
                    <select
                      id="departmentSelect"
                      name="department"
                      x-model="department"
                      @change="departmentChanged"
                      class="browser-default"
                      aria-label="Select department"
                    >
                      <option value="" disabled>Choose Department</option>
                      <template
                        x-for="dept in CONFIG.DEPARTMENTS"
                        :key="dept.key"
                      >
                        <option :value="dept.key" x-text="dept.name"></option>
                      </template>
                    </select>
                  </div>

                  <!-- SOP Selection -->
                  <div class="input-field">
                    <label for="sopSelect" class="active">SOP Template</label>
                    <select
                      id="sopSelect"
                      name="sopTemplate"
                      x-model="sopKey"
                      @change="sopChanged"
                      :disabled="sopList.length === 0"
                      class="browser-default"
                      aria-label="Select SOP template"
                    >
                      <option value="" disabled>Choose SOP Template</option>
                      <template x-for="sop in sopList" :key="sop.key">
                        <option :value="sop.key" x-text="sop.name"></option>
                      </template>
                    </select>
                  </div>

                  <!-- Loading Indicator -->
                  <div
                    x-show="isLoading"
                    class="progress blue lighten-4"
                    role="status"
                    aria-live="polite"
                  >
                    <div class="indeterminate blue"></div>
                    <span class="sr-only">Loading templates...</span>
                  </div>
                </div>

                <!-- Institution Details -->
                <div class="section">
                  <h5 class="section-title">
                    <i class="material-icons">business</i>
                    Institution Details
                  </h5>
                  <div class="input-field">
                    <input
                      type="text"
                      id="instituteName"
                      name="institutionName"
                      x-model="institute.name"
                      placeholder="Enter institution name"
                      autocomplete="organization"
                    />
                    <label for="instituteName" class="active"
                      >Institution Name *</label
                    >
                  </div>
                  <div class="input-field">
                    <input
                      type="text"
                      id="deptName"
                      name="departmentName"
                      x-model="institute.dept"
                      placeholder="Enter department name"
                      autocomplete="organization-title"
                    />
                    <label for="deptName" class="active">Department *</label>
                  </div>
                </div>

                <!-- SOP Metadata -->
                <div class="section">
                  <h5 class="section-title">
                    <i class="material-icons">info</i>
                    SOP Information
                  </h5>
                  <div class="input-field">
                    <input
                      type="text"
                      id="sopTitle"
                      name="sopTitle"
                      x-model="title"
                      placeholder="Enter SOP title"
                    />
                    <label for="sopTitle" class="active">SOP Title *</label>
                  </div>
                  <div class="row">
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="sopNumber"
                          name="sopNumber"
                          x-model="metadata.sopNumber"
                          placeholder="e.g., SOP-001"
                        />
                        <label for="sopNumber" class="active"
                          >SOP Number *</label
                        >
                      </div>
                    </div>
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="date"
                          id="effectiveDate"
                          name="effectiveDate"
                          x-model="metadata.effectiveDate"
                        />
                        <label for="effectiveDate" class="active"
                          >Effective Date *</label
                        >
                      </div>
                    </div>
                  </div>
                  <div class="input-field">
                    <input
                      type="date"
                      id="reviewDate"
                      name="nextReviewDate"
                      x-model="metadata.nextReviewDate"
                    />
                    <label for="reviewDate" class="active"
                      >Next Review Date</label
                    >
                  </div>
                </div>

                <!-- SOP Content -->
                <div class="section">
                  <h5 class="section-title">
                    <i class="material-icons">edit</i>
                    SOP Content
                  </h5>

                  <div class="input-field">
                    <textarea
                      id="purpose"
                      name="purpose"
                      class="materialize-textarea"
                      x-model="sections.purpose"
                      placeholder="Describe the purpose of this SOP"
                      rows="3"
                    ></textarea>
                    <label for="purpose" class="active">1. Purpose *</label>
                    <span class="helper-text">Minimum 20 characters</span>
                  </div>

                  <div class="input-field">
                    <textarea
                      id="scope"
                      name="scope"
                      class="materialize-textarea"
                      x-model="sections.scope"
                      placeholder="Define the scope of this SOP"
                      rows="3"
                    ></textarea>
                    <label for="scope" class="active">2. Scope *</label>
                    <span class="helper-text">Minimum 20 characters</span>
                  </div>

                  <div class="input-field">
                    <textarea
                      id="procedure"
                      name="procedure"
                      class="materialize-textarea"
                      x-model="sections.procedure"
                      placeholder="Enter procedure steps (one per line)"
                      rows="8"
                    ></textarea>
                    <label for="procedure" class="active">3. Procedure *</label>
                    <span class="helper-text"
                      >Enter each step on a new line. Minimum 30
                      characters.</span
                    >
                  </div>

                  <div class="input-field">
                    <textarea
                      id="precautions"
                      name="precautions"
                      class="materialize-textarea"
                      x-model="sections.precautions"
                      placeholder="List safety precautions and warnings"
                      rows="4"
                    ></textarea>
                    <label for="precautions" class="active"
                      >4. Precautions</label
                    >
                    <span class="helper-text"
                      >Separate sentences with periods.</span
                    >
                  </div>
                </div>

                <!-- Authority & Signatures -->
                <div class="section">
                  <h5 class="section-title">
                    <i class="material-icons">verified_user</i>
                    Authority & Approval
                  </h5>

                  <!-- Prepared By -->
                  <h6 class="subsection-title">Prepared By</h6>
                  <div class="row">
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="preparedName"
                          name="preparedByName"
                          x-model="authority.prepared"
                          placeholder="Full name"
                          autocomplete="name"
                        />
                        <label for="preparedName" class="active">Name</label>
                      </div>
                    </div>
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="preparedDesig"
                          name="preparedByDesignation"
                          x-model="authority.preparedDesig"
                          placeholder="Job title"
                          autocomplete="organization-title"
                        />
                        <label for="preparedDesig" class="active"
                          >Designation</label
                        >
                      </div>
                    </div>
                  </div>
                  <div class="input-field">
                    <input
                      type="date"
                      id="preparedDate"
                      name="preparedDate"
                      x-model="dates.prepared"
                    />
                    <label for="preparedDate" class="active">Date</label>
                  </div>

                  <!-- Reviewed/Checked By -->
                  <h6 class="subsection-title">Reviewed By</h6>
                  <div class="row">
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="reviewedName"
                          name="reviewedByName"
                          x-model="authority.reviewed"
                          placeholder="Full name"
                          autocomplete="name"
                        />
                        <label for="reviewedName" class="active">Name</label>
                      </div>
                    </div>
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="reviewedDesig"
                          name="reviewedByDesignation"
                          x-model="authority.reviewedDesig"
                          placeholder="Job title"
                          autocomplete="organization-title"
                        />
                        <label for="reviewedDesig" class="active"
                          >Designation</label
                        >
                      </div>
                    </div>
                  </div>
                  <div class="input-field">
                    <input
                      type="date"
                      id="reviewedDate"
                      name="reviewedDate"
                      x-model="dates.reviewed"
                    />
                    <label for="reviewedDate" class="active">Date</label>
                  </div>

                  <!-- Approved By -->
                  <h6 class="subsection-title">Approved By</h6>
                  <div class="row">
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="approvedName"
                          name="approvedByName"
                          x-model="authority.approved"
                          placeholder="Full name"
                          autocomplete="name"
                        />
                        <label for="approvedName" class="active">Name</label>
                      </div>
                    </div>
                    <div class="col s12 m6">
                      <div class="input-field">
                        <input
                          type="text"
                          id="approvedDesig"
                          name="approvedByDesignation"
                          x-model="authority.approvedDesig"
                          placeholder="Job title"
                          autocomplete="organization-title"
                        />
                        <label for="approvedDesig" class="active"
                          >Designation</label
                        >
                      </div>
                    </div>
                  </div>
                  <div class="input-field">
                    <input
                      type="date"
                      id="approvedDate"
                      name="approvedDate"
                      x-model="dates.approved"
                    />
                    <label for="approvedDate" class="active">Date</label>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="section action-buttons">
                  <button
                    type="button"
                    @click="printSOP()"
                    class="btn blue waves-effect waves-light"
                    :disabled="!title"
                    aria-label="Print SOP document"
                  >
                    <i class="material-icons left">print</i>
                    Print SOP
                  </button>

                  <button
                    type="button"
                    @click="copySOP()"
                    class="btn green waves-effect waves-light"
                    :disabled="!title"
                    aria-label="Copy SOP to Word format"
                  >
                    <i class="material-icons left">content_copy</i>
                    Copy to Word
                  </button>

                  <button
                    type="button"
                    @click="exportData()"
                    class="btn orange waves-effect waves-light"
                    :disabled="!title"
                    aria-label="Export SOP as JSON file"
                  >
                    <i class="material-icons left">save_alt</i>
                    Export JSON
                  </button>

                  <button
                    type="button"
                    @click="resetForm()"
                    class="btn red waves-effect waves-light"
                    aria-label="Reset form to default values"
                  >
                    <i class="material-icons left">refresh</i>
                    Reset
                  </button>
                </div>

                <!-- Status Indicator -->
                <div class="status-indicator" role="status" aria-live="polite">
                  <template x-if="!title">
                    <div class="chip blue lighten-4">
                      <i class="material-icons tiny">info_outline</i>
                      Fill in the required fields to enable printing
                    </div>
                  </template>
                  <template x-if="title">
                    <div class="chip green lighten-4">
                      <i class="material-icons tiny">check_circle</i>
                      Ready to print! Preview below
                    </div>
                  </template>
                  <template x-if="isDirty">
                    <div class="chip orange lighten-4">
                      <i class="material-icons tiny">info</i>
                      Unsaved changes (auto-save active)
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column: Preview -->
          <div class="col s12 l5">
            <div class="preview-section">
              <div class="preview-header">
                <h5>
                  <i class="material-icons">visibility</i>
                  Live Preview
                </h5>
                <div class="preview-info">
                  <span class="chip white">A4 Size (210mm × 297mm)</span>
                </div>
              </div>

              <div
                id="preview-container"
                class="preview-container"
                role="region"
                aria-label="SOP document preview"
              >
                <div id="preview" class="preview-content">
                  <!-- SOP Title -->
                  <div class="sop-header">
                    <h1 class="sop-main-title">STANDARD OPERATING PROCEDURE</h1>
                  </div>

                  <!-- Institution Details Table -->
                  <table class="sop-table">
                    <tbody>
                      <tr>
                        <td class="label-cell">Institution</td>
                        <td
                          class="value-cell"
                          x-text="institute.name || '________________'"
                        ></td>
                      </tr>
                      <tr>
                        <td class="label-cell">Department</td>
                        <td
                          class="value-cell"
                          x-text="institute.dept || '________________'"
                        ></td>
                      </tr>
                      <tr>
                        <td class="label-cell">SOP Title</td>
                        <td
                          class="value-cell"
                          x-text="title || '________________'"
                        ></td>
                      </tr>
                    </tbody>
                  </table>

                  <!-- Metadata Table -->
                  <table class="sop-table">
                    <tbody>
                      <tr>
                        <td class="label-cell" style="width: 25%">SOP No.</td>
                        <td
                          class="value-cell"
                          style="width: 25%"
                          x-text="metadata.sopNumber || '________________'"
                        ></td>
                        <td class="label-cell" style="width: 25%">
                          Effective Date
                        </td>
                        <td
                          class="value-cell"
                          style="width: 25%"
                          x-text="metadata.effectiveDate || '________________'"
                        ></td>
                      </tr>
                      <tr>
                        <td class="label-cell">Revision No.</td>
                        <td class="value-cell">________________</td>
                        <td class="label-cell">To Be Reviewed On</td>
                        <td
                          class="value-cell"
                          x-text="metadata.nextReviewDate || '________________'"
                        ></td>
                      </tr>
                    </tbody>
                  </table>

                  <!-- Purpose -->
                  <template x-if="sections.purpose">
                    <div class="sop-section">
                      <h2 class="section-heading">1.0 PURPOSE</h2>
                      <p class="section-content" x-text="sections.purpose"></p>
                    </div>
                  </template>

                  <!-- Scope -->
                  <template x-if="sections.scope">
                    <div class="sop-section">
                      <h2 class="section-heading">2.0 SCOPE</h2>
                      <p class="section-content" x-text="sections.scope"></p>
                    </div>
                  </template>

                  <!-- Responsibility -->
                  <div class="sop-section">
                    <h2 class="section-heading">3.0 RESPONSIBILITY</h2>
                    <p class="section-content">
                      Laboratory In-charge, faculty members, and trained users
                      are responsible for implementation of this SOP.
                    </p>
                  </div>

                  <!-- Procedure -->
                  <template x-if="procedureList.length > 0">
                    <div class="sop-section">
                      <h2 class="section-heading">4.0 PROCEDURE</h2>
                      <ol class="procedure-list">
                        <template
                          x-for="(step, index) in procedureList"
                          :key="index"
                        >
                          <li x-text="step"></li>
                        </template>
                      </ol>
                    </div>
                  </template>

                  <!-- Precautions -->
                  <template x-if="sections.precautions">
                    <div class="sop-section">
                      <h2 class="section-heading">5.0 PRECAUTIONS</h2>
                      <p
                        class="section-content"
                        x-text="sections.precautions"
                      ></p>
                    </div>
                  </template>

                  <!-- Signature Table -->
                  <table class="signature-table">
                    <tbody>
                      <tr>
                        <td class="signature-cell">
                          <div class="signature-label">Prepared By</div>
                          <div
                            class="signature-name"
                            x-text="authority.prepared || '________________'"
                          ></div>
                          <div
                            class="signature-desig"
                            x-text="authority.preparedDesig"
                          ></div>
                          <div class="signature-date">
                            Date:
                            <span x-text="dates.prepared || '________'"></span>
                          </div>
                        </td>
                        <td class="signature-cell">
                          <div class="signature-label">Checked By</div>
                          <div
                            class="signature-name"
                            x-text="authority.reviewed || '________________'"
                          ></div>
                          <div
                            class="signature-desig"
                            x-text="authority.reviewedDesig"
                          ></div>
                          <div class="signature-date">
                            Date:
                            <span x-text="dates.reviewed || '________'"></span>
                          </div>
                        </td>
                        <td class="signature-cell">
                          <div class="signature-label">Authorized By</div>
                          <div
                            class="signature-name"
                            x-text="authority.approved || '________________'"
                          ></div>
                          <div
                            class="signature-desig"
                            x-text="authority.approvedDesig"
                          ></div>
                          <div class="signature-date">
                            Date:
                            <span x-text="dates.approved || '________'"></span>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <!-- End Marker -->
                  <div class="sop-footer">
                    <p>— End of SOP —</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="app-footer grey lighten-3">
        <div class="container">
          <div class="footer-content">
            <p>
              <strong>Pharmacy SOP Generator</strong> v2.1.0
              <span class="separator">•</span>
              <a
                href="https://github.com/himshim/pharmacy-sop-generator"
                target="_blank"
                rel="noopener"
              >
                <i class="material-icons tiny">code</i> GitHub
              </a>
            </p>
            <p class="grey-text text-darken-1">
              Generate professional SOPs for pharmaceutical laboratories
            </p>
          </div>
        </div>
      </footer>
    </div>

    <!-- Toast Container for Notifications -->
    <div id="toast-container" role="alert" aria-live="assertive"></div>

    <!-- Scripts - FIXED: Removed defer from Alpine, added cache busting -->

    <!-- 1. Materialize CSS Framework -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- 2. Alpine.js - CRITICAL FIX: Removed defer attribute -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- 3. Application Configuration -->
    <script src="config.js?v=2.1.0"></script>

    <!-- 4. Utility Functions -->
    <script src="js/utils.js?v=2.1.0"></script>

    <!-- 5. Core Modules (in dependency order) -->
    <script src="js/modules/validation.js?v=2.1.0"></script>
    <script src="js/modules/storage.js?v=2.1.0"></script>
    <script src="js/modules/sopLoader.js?v=2.1.0"></script>

    <!-- 6. Application Logic -->
    <script src="js/alpineApp.js?v=2.1.0"></script>
    <script src="js/export.js?v=2.1.0"></script>

    <!-- 7. Debug & Initialization -->
    <script>
      // Comprehensive debug logging
      console.log(
        "%c=== Pharmacy SOP Generator v2.1.0 ===",
        "color: #1976d2; font-size: 16px; font-weight: bold"
      );
      console.log(
        "Alpine.js:",
        typeof Alpine !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );
      console.log(
        "CONFIG:",
        typeof CONFIG !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );
      console.log(
        "ValidationModule:",
        typeof ValidationModule !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );
      console.log(
        "StorageModule:",
        typeof StorageModule !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );
      console.log(
        "SOPLoader:",
        typeof SOPLoader !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );
      console.log(
        "sopApp:",
        typeof sopApp !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );
      console.log(
        "copySOP:",
        typeof copySOP !== "undefined" ? "✅ Loaded" : "❌ FAILED"
      );

      // Initialize Materialize components after DOM load
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing Materialize...");

 // ❌ DO NOT initialize Materialize selects
// Alpine controls <select> via x-model

        // Initialize modals (if any)
        var modals = document.querySelectorAll(".modal");
        M.Modal.init(modals);

        // Initialize tooltips (if any)
        var tooltips = document.querySelectorAll(".tooltipped");
        M.Tooltip.init(tooltips);

        console.log("Materialize initialized ✅");
        console.log(
          "%cIf you see all ✅ green checkmarks above, the app is working correctly!",
          "color: green; font-weight: bold"
        );
      });
    </script>
  </body>
</html>
