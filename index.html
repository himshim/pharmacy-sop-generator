<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pharmacy SOP Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Alpine -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">
</head>

<!-- âœ… STEP 5D: init() instead of loadSOP -->
<body class="grey lighten-4" x-data="sopApp()" x-init="init()">

<nav class="blue darken-2 no-print">
  <div class="nav-wrapper container">
    <span class="brand-logo">Pharmacy SOP Generator</span>
  </div>
</nav>

<div class="container section no-print">

  <!-- FORMAT -->
  <div class="card">
    <div class="card-content">
      <span class="card-title">SOP Format</span>
      <a class="btn blue" @click="toggleFormat()">Switch Format</a>
    </div>
  </div>

  <!-- FORM -->
  <div class="row">
    <div class="col s12 m6">

      <!-- INSTITUTE -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">Institute</span>
          <input placeholder="Institute Name" x-model="institute.name">
          <input placeholder="Department" x-model="institute.dept">
        </div>
      </div>

      <!-- SOP CONTENT -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">SOP Content</span>

          <!-- SOP SELECT (from department index.json) -->
          <div class="input-field">
            <select x-model="sopKey" @change="loadSOP(sopKey)">
              <template x-for="sop in sopList" :key="sop.key">
                <option :value="sop.key" x-text="sop.name"></option>
              </template>
            </select>
            <label>Select SOP</label>
          </div>

          <input placeholder="SOP Title" x-model="title">

          <textarea placeholder="Purpose"
                    x-model="sections.purpose"
                    class="materialize-textarea"></textarea>

          <textarea placeholder="Scope"
                    x-model="sections.scope"
                    class="materialize-textarea"></textarea>

          <textarea placeholder="Procedure (one per line)"
                    x-model="sections.procedure"
                    class="materialize-textarea"></textarea>

          <textarea placeholder="Precautions"
                    x-model="sections.precautions"
                    class="materialize-textarea"></textarea>
        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="col s12 m6">

      <div class="card">
        <div class="card-content">
          <span class="card-title">Authorities</span>
          <input placeholder="Prepared By" x-model="authority.prepared">
          <input placeholder="Reviewed By" x-model="authority.reviewed">
          <input placeholder="Approved By" x-model="authority.approved">
          <input type="date" x-model="dates.prepared">
          <input type="date" x-model="dates.reviewed">
        </div>
      </div>

      <div class="card center-align">
        <div class="card-content">
          <button class="btn green" onclick="window.print()">Print SOP</button>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- ================= PRINT ZONE ================= -->
<div id="print-zone">
  <div id="preview">

    <!-- BEGINNER -->
    <template x-if="format === 'beginner'">
      <div>
        <h2 x-text="institute.name"></h2>
        <h3>STANDARD OPERATING PROCEDURE</h3>

        <p><b>Department:</b> <span x-text="institute.dept"></span></p>
        <p><b>SOP Title:</b> <span x-text="title"></span></p>

        <h4>Purpose</h4>
        <p x-text="sections.purpose"></p>

        <h4>Scope</h4>
        <p x-text="sections.scope"></p>

        <h4>Procedure</h4>
        <template x-for="(s,i) in procedure" :key="i">
          <p x-text="(i+1)+'. '+s"></p>
        </template>

        <h4>Precautions</h4>
        <p x-text="sections.precautions"></p>
      </div>
    </template>

    <!-- INSPECTION -->
    <template x-if="format === 'inspection'">
      <div>
        <h2>STANDARD OPERATING PROCEDURE</h2>

        <table>
          <tr><td>Institution</td><td x-text="institute.name"></td></tr>
          <tr><td>Department</td><td x-text="institute.dept"></td></tr>
          <tr><td>SOP Title</td><td x-text="title"></td></tr>
        </table>

        <h4>1.0 PURPOSE</h4>
        <p x-text="sections.purpose"></p>

        <h4>2.0 SCOPE</h4>
        <p x-text="sections.scope"></p>

        <h4>3.0 PROCEDURE</h4>
        <template x-for="(s,i) in procedure" :key="i">
          <p x-text="'3.'+(i+1)+' '+s"></p>
        </template>

        <h4>4.0 PRECAUTIONS</h4>
        <p x-text="sections.precautions"></p>
      </div>
    </template>

    <!-- SIGNATURES -->
    <table>
      <tr>
        <td>
          Prepared By<br>
          <span x-text="authority.prepared"></span><br>
          Date: <span x-text="dates.prepared"></span>
        </td>
        <td>
          Reviewed By<br>
          <span x-text="authority.reviewed"></span><br>
          Date: <span x-text="dates.reviewed"></span>
        </td>
        <td>
          Approved By<br>
          <span x-text="authority.approved"></span>
        </td>
      </tr>
    </table>

  </div>
</div>

<!-- JS -->
<script src="js/alpineApp.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    M.FormSelect.init(document.querySelectorAll('select'));
  });
</script>

</body>
</html>